# HMS-A2A Prover Integration Plan

## 1. Goal
Formally verify economic properties (e.g., Pareto efficiency, Nash equilibrium, market-clearing) and contractual deal-invariants produced by the **mac/** and **specialized_agents/collaboration/** subsystems using Lean 4 proofs generated by **DeepSeek-Prover-V2**. The outcome is an automated theorem-proving pipeline that:
1. Converts agent-generated economic statements into Lean conjectures.
2. Invokes DeepSeek-Prover-V2 (remote API or local GPU) to synthesize proofs.
3. Validates proofs with Lean and feeds success/failure metrics back to GA self-healing loops.

## 2. Architectural Overview
```
mac/ (economic models)              collaboration/ (deal agents)
└─ economist_agent.py ──┐          ┌─ cort_deal_negotiator.py
                        │          │
           (JSON theorem spec)     │
                        ▼          ▼
               theorem_bus  (Redis / NATS)
                        ▼
        prover-orchestrator (Rust/TS service)
                        ▼
               DeepSeek-Prover-V2
                        ▼
                  Lean verifier
                        ▼
             metrics + GA feedback
```

## 3. Component Tasks
| # | Component | Task | Deliverable |
|---|-----------|------|-------------|
| 1 | __Extraction Layer__ | Add decorators / AST walkers in `economist_agent.py`, `deal_tools.py` to tag Python functions returning statements like `assert_equilibrium(market)` → emit JSON: `{ theorem: "WalrasLaw", params: …}` | `utils/theorem_exporter.py` |
| 2 | __Spec Schema__ | Define `theorem_spec.schema.json` capturing name, context, assumptions, conclusion, types. | JSON schema in `schemas/` |
| 3 | __Translation Engine__ | TS module `translator.ts` converts JSON spec → Lean 4 conjecture template using mathlib terms. | `src/translation/translator.ts` |
| 4 | __Prover Orchestrator__ | Rust microservice (could reuse codex-cli) that batches Lean files, calls DeepSeek-Prover-V2, collects outputs, verifies via Lean CLI. | `prover-orchestrator` crate |
| 5 | __Feedback Loop__ | On proof success store certificate hash; on failure, queue for human/GA refinement. Emit metrics (`proof_latency`, `success_rate`). | Influx/Prom scraper |
| 6 | __GA Integration__ | Extend GA fitness to penalize unresolved critical theorems; mutation operator suggests alternative market parameters if proofs fail. | GA module PR |
| 7 | __CI/CD__ | GitHub Action to run translator+prover on every PR touching economic logic. | `.github/workflows/prover.yml` |

## 4. Proof Targets (Initial Backlog)
| ID | Source File | Informal Claim | Priority |
|----|-------------|---------------|----------|
| E-01 | market_models.py | `WalrasLaw` holds for generated equilibrium | P0 |
| E-02 | network_effects.py | Network equilibrium is stable (∑Δutility ≤ 0) | P1 |
| D-01 | deals.py | No-arbitrage between linked deals after settlement | P0 |
| D-02 | cort_deal_negotiator.py | Nash bargaining solution maximizes product of gains | P1 |

## 5. Phased Timeline
### Phase 1 (Week 1-2) – Foundations
• Implement theorem_spec schema & exporter decorators.  
• Prototype translator for a simple equality claim.  
• Smoke-test DeepSeek-Prover-V2 locally.

### Phase 2 (Week 3-4) – Orchestrator & Verification
• Build Rust service wrapping prover API and Lean verification.  
• Provide CLI `prove-spec theorem.json`.

### Phase 3 (Week 5-6) – Full Pipeline & Metrics
• Wire exporter → bus → orchestrator.  
• Store artifacts in S3/minio; expose Prom metrics.

### Phase 4 (Week 7) – GA Feedback & Self-Healing
• Add metric ingestion to GA fitness.  
• Implement mutation operator `AdjustMarketParam` targeting failed proofs.

### Phase 5 (Week 8) – Scale-out & Optimization
• Parallelize prover jobs with token-budget scheduling.  
• Incremental Lean context reuse for speed.

## 6. Risk & Mitigation
| Risk | Mitigation |
|------|-----------|
| Lean encoding mismatch | Maintain library of common econ lemmas; auto-import. |
| Prover timeouts | Adaptive time budget, fallback to smaller subgoals via DSP approach. |
| Large JSON specs | Chunk assumptions, use Lean `by` blocks. |

## 7. AI-Executable Checklist
| TaskID | Step | Success Criteria |
|--------|------|-----------------|
| `SpecSchema` | Commit JSON schema | CI jsonschema test passes |
| `ExporterDemo` | Emit sample Walras spec | File generated in `artifacts/specs/E-01.json` |
| `LeanTranslate` | translator compiles Lean file | `lean --make` exits 0 |
| `ProverRun` | orchestrator proves E-01 | Verified proof stored |
| `MetricsExpose` | `/metrics` shows `proof_success_total` | Curl returns metric |
| `GAHook` | GA fitness reflects proof status | Simulation shows penalty on fail |

---
_This plan positions HMS-A2A to formally guarantee economic and contractual correctness, tapping DeepSeek-Prover-V2's state-of-the-art reasoning while feeding live metrics into the self-healing GA pipeline._ 